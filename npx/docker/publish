#!/bin/bash

# Docker Hub image name
IMAGE_NAME="claudiombsilva/claude-artifact-runner"

# Navigate to docker directory first
cd "$(dirname "$0")"

# Get version from npx/package.json (one level up from docker/)
VERSION=$(node -p "require('../package.json').version" 2>/dev/null || echo "latest")

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}üê≥ Publishing Docker image to Docker Hub${NC}"
echo -e "${BLUE}Image: ${IMAGE_NAME}${NC}"
echo -e "${BLUE}Version: ${VERSION}${NC}"
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo -e "${YELLOW}‚ùå Docker is not running. Please start Docker and try again.${NC}"
    exit 1
fi

# Check if image exists
if ! docker images | grep -q "${IMAGE_NAME}.*${VERSION}"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Image ${IMAGE_NAME}:${VERSION} not found.${NC}"
    echo -e "${BLUE}Building image first...${NC}"
    echo ""
    "$(dirname "$0")/build"
    if [ $? -ne 0 ]; then
        exit 1
    fi
    echo ""
fi

# Check if user is logged in to Docker Hub
if ! docker info | grep -q "Username:"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Not logged in to Docker Hub. Please login first:${NC}"
    echo -e "  docker login"
    exit 1
fi

# Push the image
echo -e "${BLUE}üì§ Pushing Docker image to Docker Hub...${NC}"
docker push "${IMAGE_NAME}:${VERSION}"
docker push "${IMAGE_NAME}:latest"

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Successfully published to Docker Hub!${NC}"
    echo ""
    echo -e "${BLUE}Usage:${NC}"
    echo -e "  docker run --rm -v \$(pwd):/w -w /w ${IMAGE_NAME} <artifact-file.tsx>"
else
    echo -e "${YELLOW}‚ùå Failed to push to Docker Hub.${NC}"
    exit 1
fi

