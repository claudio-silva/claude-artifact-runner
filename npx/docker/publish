#!/bin/bash

# Docker Hub image name
IMAGE_NAME="claudiombsilva/claude-artifact-runner"

# Navigate to docker directory first
cd "$(dirname "$0")"

# Get version from npx/package.json (one level up from docker/)
VERSION=$(node -p "require('../package.json').version" 2>/dev/null || echo "latest")

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}üê≥ Publishing Docker image to Docker Hub${NC}"
echo -e "${BLUE}Image: ${IMAGE_NAME}${NC}"
echo -e "${BLUE}Version: ${VERSION}${NC}"
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo -e "${YELLOW}‚ùå Docker is not running. Please start Docker and try again.${NC}"
    exit 1
fi

# Check if Docker Hub credentials exist in config
# Docker Hub can be stored as "https://index.docker.io/v1/" or "docker.io"
DOCKER_CONFIG="${HOME}/.docker/config.json"

if [ ! -f "$DOCKER_CONFIG" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Not logged in to Docker Hub. Please login first:${NC}"
    echo -e "  docker login"
    exit 1
fi

if ! grep -qE "(https://index\.docker\.io/v1/|docker\.io)" "$DOCKER_CONFIG" 2>/dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Not logged in to Docker Hub. Please login first:${NC}"
    echo -e "  docker login"
    exit 1
fi

# Prompt for confirmation
echo -e "${BLUE}‚úì Docker Hub login detected${NC}"
read -p "Make sure you are logged in as claudiombsilva and press Enter to continue: "
echo ""

# Check if buildx is available (required for multi-architecture builds)
if ! docker buildx version > /dev/null 2>&1; then
    echo -e "${YELLOW}‚ö†Ô∏è  Docker buildx not available. Cannot build multi-architecture images.${NC}"
    echo -e "${YELLOW}   Please install Docker buildx or use Docker Desktop.${NC}"
    exit 1
fi

# Set up buildx builder for multi-architecture builds
echo -e "${BLUE}üîß Setting up buildx builder...${NC}"
if ! docker buildx ls | grep -q "claude-artifact-builder"; then
    docker buildx create --name claude-artifact-builder --use
else
    docker buildx use claude-artifact-builder
fi

# Build and push multi-architecture images
# Note: We always rebuild here to ensure both architectures are built and pushed
echo -e "${BLUE}üì¶ Building and pushing Docker images for amd64 and arm64...${NC}"
docker buildx build \
    --platform linux/amd64,linux/arm64 \
    --tag "${IMAGE_NAME}:${VERSION}" \
    --tag "${IMAGE_NAME}:latest" \
    --push \
    .

if [ $? -eq 0 ]; then
    echo ""
    echo -e "${GREEN}‚úÖ Successfully published multi-architecture images to Docker Hub!${NC}"
    echo -e "${GREEN}   Platforms: linux/amd64, linux/arm64${NC}"
    echo ""
    echo -e "${BLUE}Usage:${NC}"
    echo -e "  docker run --rm -p 5173:5173 -v \$(pwd):/w -w /w ${IMAGE_NAME} <artifact-file.tsx>"
else
    echo -e "${YELLOW}‚ùå Build and push failed.${NC}"
    exit 1
fi

