#!/bin/bash

# Docker Hub image name
IMAGE_NAME="claudiombsilva/claude-artifact-runner"

# Navigate to docker directory first
cd "$(dirname "$0")"

# Get version from npx/package.json (one level up from docker/)
VERSION=$(node -p "require('../package.json').version" 2>/dev/null || echo "latest")

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}üê≥ Publishing Docker image to Docker Hub${NC}"
echo -e "${BLUE}Image: ${IMAGE_NAME}${NC}"
echo -e "${BLUE}Version: ${VERSION}${NC}"
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo -e "${YELLOW}‚ùå Docker is not running. Please start Docker and try again.${NC}"
    exit 1
fi

# Check if image exists
if ! docker images | grep -q "${IMAGE_NAME}.*${VERSION}"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Image ${IMAGE_NAME}:${VERSION} not found.${NC}"
    echo -e "${BLUE}Building image first...${NC}"
    echo ""
    "$(dirname "$0")/build"
    if [ $? -ne 0 ]; then
        exit 1
    fi
    echo ""
fi

# Check if user is logged in to Docker Hub
DOCKER_CONFIG="${HOME}/.docker/config.json"

if [ ! -f "$DOCKER_CONFIG" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Not logged in to Docker Hub. Please login first:${NC}"
    echo -e "  docker login"
    exit 1
fi

# Check if Docker Hub credentials exist in config
# Docker Hub can be stored as "https://index.docker.io/v1/" or "docker.io"
if ! grep -qE "(https://index\.docker\.io/v1/|docker\.io)" "$DOCKER_CONFIG" 2>/dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Not logged in to Docker Hub. Please login first:${NC}"
    echo -e "  docker login"
    exit 1
fi

# Prompt for confirmation
echo -e "${BLUE}‚úì Docker Hub login detected${NC}"
read -p "Make sure you are logged in as claudiombsilva and press Enter to continue: "
echo ""

# Push the image
echo -e "${BLUE}üì§ Pushing Docker image to Docker Hub...${NC}"
docker push "${IMAGE_NAME}:${VERSION}"
docker push "${IMAGE_NAME}:latest"

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Successfully published to Docker Hub!${NC}"
    echo ""
    echo -e "${BLUE}Usage:${NC}"
    echo -e "  docker run --rm -v \$(pwd):/w -w /w ${IMAGE_NAME} <artifact-file.tsx>"
else
    echo -e "${YELLOW}‚ùå Failed to push to Docker Hub.${NC}"
    exit 1
fi

